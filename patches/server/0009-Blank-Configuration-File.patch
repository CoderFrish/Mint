From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Kercute <A3167717663@hotmail.com>
Date: Sat, 18 Jan 2025 13:26:43 +0800
Subject: [PATCH] Blank Configuration File


diff --git a/build.gradle.kts b/build.gradle.kts
index f5f9bfbf4254df0cf082b0d6f2a3718450c2b45c..50587cde5dcc9cb61ffd8e0a0998a77e2e5c8c3e 100644
--- a/build.gradle.kts
+++ b/build.gradle.kts
@@ -14,6 +14,8 @@ val alsoShade: Configuration by configurations.creating
 
 dependencies {
     implementation(project(":mint-api")) // Folia // Mint
+    implementation("io.github.classgraph:classgraph:4.8.179") // Mint
+    implementation("com.electronwill.night-config:toml:3.6.6") // Mint
     // Paper start
     implementation("org.jline:jline-terminal-jansi:3.21.0")
     implementation("net.minecrell:terminalconsoleappender:1.3.0")
diff --git a/src/main/java/com/menthamc/mint/config/ConfigCategory.java b/src/main/java/com/menthamc/mint/config/ConfigCategory.java
new file mode 100644
index 0000000000000000000000000000000000000000..2e91061279e8efb96ef458d1213ff8b054001592
--- /dev/null
+++ b/src/main/java/com/menthamc/mint/config/ConfigCategory.java
@@ -0,0 +1,6 @@
+package com.menthamc.mint.config;
+
+public enum ConfigCategory {
+    fix,
+    misc;
+}
diff --git a/src/main/java/com/menthamc/mint/config/ConfigField.java b/src/main/java/com/menthamc/mint/config/ConfigField.java
new file mode 100644
index 0000000000000000000000000000000000000000..0afa60f05343763e185a2b6af8f27aa2267afc08
--- /dev/null
+++ b/src/main/java/com/menthamc/mint/config/ConfigField.java
@@ -0,0 +1,12 @@
+package com.menthamc.mint.config;
+
+import java.lang.annotation.ElementType;
+import java.lang.annotation.Retention;
+import java.lang.annotation.RetentionPolicy;
+import java.lang.annotation.Target;
+
+@Target(ElementType.FIELD)
+@Retention(RetentionPolicy.RUNTIME)
+public @interface ConfigField {
+    String[] comment() default {};
+}
diff --git a/src/main/java/com/menthamc/mint/config/ConfigSkipLoad.java b/src/main/java/com/menthamc/mint/config/ConfigSkipLoad.java
new file mode 100644
index 0000000000000000000000000000000000000000..6384ccdd34f93951639efc73347677b99b3246f5
--- /dev/null
+++ b/src/main/java/com/menthamc/mint/config/ConfigSkipLoad.java
@@ -0,0 +1,11 @@
+package com.menthamc.mint.config;
+
+import java.lang.annotation.ElementType;
+import java.lang.annotation.Retention;
+import java.lang.annotation.RetentionPolicy;
+import java.lang.annotation.Target;
+
+@Retention(RetentionPolicy.RUNTIME)
+@Target({ElementType.TYPE, ElementType.FIELD})
+public @interface ConfigSkipLoad {
+}
diff --git a/src/main/java/com/menthamc/mint/config/Configuration.java b/src/main/java/com/menthamc/mint/config/Configuration.java
new file mode 100644
index 0000000000000000000000000000000000000000..e441ace6c0acdb984258c3b06332ede38f1f7965
--- /dev/null
+++ b/src/main/java/com/menthamc/mint/config/Configuration.java
@@ -0,0 +1,16 @@
+package com.menthamc.mint.config;
+
+import java.lang.annotation.ElementType;
+import java.lang.annotation.Retention;
+import java.lang.annotation.RetentionPolicy;
+import java.lang.annotation.Target;
+
+@Retention(RetentionPolicy.RUNTIME)
+@Target(ElementType.TYPE)
+public @interface Configuration {
+    String name();
+
+    ConfigCategory type();
+
+    String[] comment() default {};
+}
diff --git a/src/main/java/com/menthamc/mint/config/IConfigModule.java b/src/main/java/com/menthamc/mint/config/IConfigModule.java
new file mode 100644
index 0000000000000000000000000000000000000000..5b6ac7ce80db1614e3d25f9370ed945b8d6d38b5
--- /dev/null
+++ b/src/main/java/com/menthamc/mint/config/IConfigModule.java
@@ -0,0 +1,4 @@
+package com.menthamc.mint.config;
+
+public interface IConfigModule {
+}
diff --git a/src/main/java/com/menthamc/mint/config/MintConfig.java b/src/main/java/com/menthamc/mint/config/MintConfig.java
new file mode 100644
index 0000000000000000000000000000000000000000..4a298b5fe8143dbebd0c508743ec892a62db1acb
--- /dev/null
+++ b/src/main/java/com/menthamc/mint/config/MintConfig.java
@@ -0,0 +1,119 @@
+package com.menthamc.mint.config;
+
+import com.electronwill.nightconfig.core.file.CommentedFileConfig;
+import io.github.classgraph.ClassGraph;
+import io.github.classgraph.ClassInfo;
+import io.github.classgraph.ScanResult;
+import org.slf4j.Logger;
+import org.slf4j.LoggerFactory;
+
+import java.io.File;
+import java.lang.reflect.Field;
+import java.lang.reflect.Modifier;
+import java.nio.charset.StandardCharsets;
+import java.util.Arrays;
+import java.util.Set;
+import java.util.stream.Collectors;
+
+public class MintConfig {
+    private static final Logger LOGGER = LoggerFactory.getLogger(MintConfig.class);
+    private static final File baseConfigFolder = new File("mint");
+    private static final File baseConfigFile = new File(baseConfigFolder, "mint_global.toml");
+    private static final CommentedFileConfig configuration;
+
+    static {
+        if (!baseConfigFolder.exists()) {
+            if (!baseConfigFolder.mkdirs()) {
+                throw new RuntimeException("Unable to create `mint` folder.");
+            }
+        }
+        configuration = CommentedFileConfig.builder(baseConfigFile)
+                .concurrent().charset(StandardCharsets.UTF_8).build();
+    }
+
+    public static void setup() {
+    }
+
+    public static void loadConfig() {
+        // Loaded this config file.
+        if (baseConfigFile.exists()) {
+            configuration.load();
+        }
+
+        Set<Class<?>> moduleClasses = getClassesByPackage();
+        for (Class<?> clazz : moduleClasses) {
+            loadConfigInstance(clazz);
+        }
+
+        configuration.save();
+    }
+
+    private static void loadConfigInstance(Class<?> moduleClass) {
+        try {
+            if (Arrays.stream(moduleClass.getInterfaces())
+                    .collect(Collectors.toSet()).contains(IConfigModule.class)
+            ) {
+                int clazzModifiers = moduleClass.getModifiers();
+                if (!moduleClass.isAnnotationPresent(Configuration.class) || moduleClass.isAnnotationPresent(ConfigSkipLoad.class))
+                    return;
+                if (!(Modifier.isPublic(clazzModifiers) && isPlainClass(moduleClass))) {
+                    LOGGER.error("`{}` must be public and plain class!", moduleClass.getName(), new RuntimeException());
+                    return;
+                }
+
+                Configuration cfg = moduleClass.getDeclaredAnnotation(Configuration.class);
+                for (Field field : moduleClass.getDeclaredFields()) {
+                    int fieldModifiers = field.getModifiers();
+                    if (!field.isAnnotationPresent(ConfigField.class) || field.isAnnotationPresent(ConfigSkipLoad.class))
+                        continue;
+                    if (!(Modifier.isStatic(fieldModifiers) && Modifier.isPublic(fieldModifiers))) {
+                        LOGGER.error("`{}` must be public and static!", field.getName(), new RuntimeException());
+                        continue;
+                    }
+
+                    ConfigField config = field.getDeclaredAnnotation(ConfigField.class);
+                    String fullPath = cfg.type().name() + "." + cfg.name() + "." + field.getName();
+
+                    if (!configuration.contains(fullPath)) {
+                        configuration.add(fullPath, field.get(null));
+
+                        setComment(config.comment(), fullPath);
+                    }
+
+                    field.set(null, configuration.get(fullPath));
+                }
+
+                setComment(cfg.comment(), cfg.type().name() + "." + cfg.name());
+            }
+        } catch (Exception e) {
+            throw new RuntimeException(e);
+        }
+    }
+
+    public static void reloadConfig() {
+        loadConfig();
+    }
+
+    private static void setComment(String[] comment, String fullPath) {
+        if (comment.length > 0) {
+            StringBuilder builder = new StringBuilder();
+            for (int i = 0; i < comment.length; i++) {
+                builder.append(" ").append(comment[i]);
+                if (i < comment.length - 1)
+                    builder.append("\n");
+            }
+
+            configuration.setComment(fullPath, builder.toString());
+        }
+    }
+
+    private static Set<Class<?>> getClassesByPackage() {
+        try(ScanResult result = new ClassGraph().acceptPackages("com.menthamc.mint.config.modules").scan()) {
+            return result.getAllClasses().stream().map(ClassInfo::loadClass).collect(Collectors.toSet());
+        }
+    }
+
+    private static boolean isPlainClass(Class<?> clazz) {
+        return !clazz.isAnnotation() && !clazz.isInterface() && !clazz.isEnum() && !Modifier.isAbstract(clazz.getModifiers());
+    }
+}
diff --git a/src/main/java/com/menthamc/mint/config/modules/fix/UnsafeTeleportationConfig.java b/src/main/java/com/menthamc/mint/config/modules/fix/UnsafeTeleportationConfig.java
new file mode 100644
index 0000000000000000000000000000000000000000..6fee15142ee604a094b71a743fe004063536e499
--- /dev/null
+++ b/src/main/java/com/menthamc/mint/config/modules/fix/UnsafeTeleportationConfig.java
@@ -0,0 +1,15 @@
+package com.menthamc.mint.config.modules.fix;
+
+import com.menthamc.mint.config.ConfigCategory;
+import com.menthamc.mint.config.ConfigField;
+import com.menthamc.mint.config.Configuration;
+import com.menthamc.mint.config.IConfigModule;
+
+@Configuration(name = "unsafe-teleportation", type = ConfigCategory.fix)
+public class UnsafeTeleportationConfig implements IConfigModule {
+    @ConfigField(comment = {
+            "If you want to use sand duping,please turn on this.",
+            "Warning: This would cause some unsafe issues, you could learn more on : https://github.com/PaperMC/Folia/issues/297"
+    })
+    public static boolean enabled = false;
+}
diff --git a/src/main/java/com/menthamc/mint/config/modules/fix/VoidTradingFixConfig.java b/src/main/java/com/menthamc/mint/config/modules/fix/VoidTradingFixConfig.java
new file mode 100644
index 0000000000000000000000000000000000000000..e73755e3870c494b37232e80c3c44a3dc15dce93
--- /dev/null
+++ b/src/main/java/com/menthamc/mint/config/modules/fix/VoidTradingFixConfig.java
@@ -0,0 +1,12 @@
+package com.menthamc.mint.config.modules.fix;
+
+import com.menthamc.mint.config.ConfigCategory;
+import com.menthamc.mint.config.ConfigField;
+import com.menthamc.mint.config.Configuration;
+import com.menthamc.mint.config.IConfigModule;
+
+@Configuration(name = "void-trading-fix", type = ConfigCategory.fix)
+public class VoidTradingFixConfig implements IConfigModule {
+    @ConfigField
+    public static boolean enabled = false;
+}
diff --git a/src/main/java/com/menthamc/mint/config/modules/misc/ServerModNameConfig.java b/src/main/java/com/menthamc/mint/config/modules/misc/ServerModNameConfig.java
new file mode 100644
index 0000000000000000000000000000000000000000..40d274ced66349840a1cb391a5d2a8f5f49f7b17
--- /dev/null
+++ b/src/main/java/com/menthamc/mint/config/modules/misc/ServerModNameConfig.java
@@ -0,0 +1,12 @@
+package com.menthamc.mint.config.modules.misc;
+
+import com.menthamc.mint.config.ConfigCategory;
+import com.menthamc.mint.config.ConfigField;
+import com.menthamc.mint.config.Configuration;
+import com.menthamc.mint.config.IConfigModule;
+
+@Configuration(name = "server-name", type = ConfigCategory.misc)
+public class ServerModNameConfig implements IConfigModule {
+    @ConfigField(comment = "This can change the server name.")
+    public static String serverModName= "Mint";
+}
diff --git a/src/main/java/net/minecraft/server/MinecraftServer.java b/src/main/java/net/minecraft/server/MinecraftServer.java
index 4ed79a51c89d54a7b2ab65a99b5b09cc807f4d4e..e067b2950baef8346c9c4bf85b0eb073af8b1bee 100644
--- a/src/main/java/net/minecraft/server/MinecraftServer.java
+++ b/src/main/java/net/minecraft/server/MinecraftServer.java
@@ -3,9 +3,6 @@ package net.minecraft.server;
 import com.google.common.base.Preconditions;
 import com.google.common.base.Splitter;
 import com.google.common.collect.ImmutableList;
-import co.aikar.timings.Timings;
-import com.destroystokyo.paper.event.server.PaperServerListPingEvent;
-import com.google.common.base.Stopwatch;
 import com.google.common.collect.Lists;
 import com.google.common.collect.Maps;
 import com.google.common.collect.Sets;
@@ -106,7 +103,6 @@ import net.minecraft.util.datafix.DataFixers;
 import net.minecraft.util.debugchart.RemoteDebugSampleType;
 import net.minecraft.util.debugchart.SampleLogger;
 import net.minecraft.util.debugchart.TpsDebugDimensions;
-import net.minecraft.util.profiling.EmptyProfileResults;
 import net.minecraft.util.profiling.ProfileResults;
 import net.minecraft.util.profiling.ProfilerFiller;
 import net.minecraft.util.profiling.ResultField;
diff --git a/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java b/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java
index 301d7fa29fce2997a5881b3852896eff5af33672..8ed28f10ed6f7413e774cee7af959720663735a3 100644
--- a/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java
+++ b/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java
@@ -1,20 +1,17 @@
 package net.minecraft.server.dedicated;
 
-import com.google.common.collect.Lists;
+import com.menthamc.mint.config.MintConfig;
 import com.mojang.authlib.GameProfile;
 import com.mojang.datafixers.DataFixer;
 import com.mojang.logging.LogUtils;
-import java.io.BufferedReader;
+
 import java.io.BufferedWriter;
 import java.io.IOException;
-import java.io.InputStreamReader;
 import java.net.InetAddress;
 import java.net.Proxy;
 import java.net.URI;
-import java.nio.charset.StandardCharsets;
 import java.nio.file.Files;
 import java.nio.file.Path;
-import java.util.Collections;
 import java.util.List;
 import java.util.Locale;
 import java.util.Optional;
@@ -66,8 +63,6 @@ import org.apache.logging.log4j.LogManager;
 import org.apache.logging.log4j.io.IoBuilder;
 import org.bukkit.command.CommandSender;
 import co.aikar.timings.MinecraftTimings; // Paper
-import org.bukkit.craftbukkit.util.TerminalCompletionHandler;
-import org.bukkit.craftbukkit.util.TerminalConsoleWriterThread;
 import org.bukkit.event.server.ServerCommandEvent;
 import org.bukkit.craftbukkit.util.Waitable; // Paper
 import org.bukkit.event.server.RemoteServerCommandEvent;
@@ -226,6 +221,8 @@ public class DedicatedServer extends MinecraftServer implements ServerInterface
         this.paperConfigurations.initializeGlobalConfiguration(this.registryAccess());
         this.paperConfigurations.initializeWorldDefaultsConfiguration(this.registryAccess());
         // Paper end - initialize global and world-defaults configuration
+        MintConfig.loadConfig(); // Mint
+        MintConfig.setup(); // Mint
         this.server.spark.enableEarlyIfRequested(); // Paper - spark
         // Paper start - fix converting txt to json file; convert old users earlier after PlayerList creation but before file load/save
         if (this.convertOldUsers()) {
diff --git a/src/main/java/net/minecraft/server/level/ServerLevel.java b/src/main/java/net/minecraft/server/level/ServerLevel.java
index 90d78ddf8518c0df307cdaa8b7cfb5549491c6e5..da9b698d943517a9bcd20b1ae84a7874ba840073 100644
--- a/src/main/java/net/minecraft/server/level/ServerLevel.java
+++ b/src/main/java/net/minecraft/server/level/ServerLevel.java
@@ -3,6 +3,7 @@ package net.minecraft.server.level;
 import com.google.common.annotations.VisibleForTesting;
 import co.aikar.timings.TimingHistory; // Paper
 import com.google.common.collect.Lists;
+import com.menthamc.mint.config.modules.fix.VoidTradingFixConfig;
 import com.mojang.datafixers.DataFixer;
 import com.mojang.datafixers.util.Pair;
 import com.mojang.logging.LogUtils;
@@ -14,7 +15,6 @@ import it.unimi.dsi.fastutil.objects.Object2IntMap.Entry;
 import it.unimi.dsi.fastutil.objects.Object2IntOpenHashMap;
 import it.unimi.dsi.fastutil.objects.ObjectArrayList;
 import it.unimi.dsi.fastutil.objects.ObjectIterator;
-import it.unimi.dsi.fastutil.objects.ObjectLinkedOpenHashSet;
 import it.unimi.dsi.fastutil.objects.ObjectOpenHashSet;
 import java.io.BufferedWriter;
 import java.io.IOException;
@@ -140,11 +140,9 @@ import net.minecraft.world.level.dimension.BuiltinDimensionTypes;
 import net.minecraft.world.level.dimension.LevelStem;
 import net.minecraft.world.level.dimension.end.EndDragonFight;
 import net.minecraft.world.level.entity.EntityPersistentStorage;
-import net.minecraft.world.level.entity.EntityTickList;
 import net.minecraft.world.level.entity.EntityTypeTest;
 import net.minecraft.world.level.entity.LevelCallback;
 import net.minecraft.world.level.entity.LevelEntityGetter;
-import net.minecraft.world.level.entity.PersistentEntitySectionManager;
 import net.minecraft.world.level.gameevent.DynamicGameEventListener;
 import net.minecraft.world.level.gameevent.GameEvent;
 import net.minecraft.world.level.gameevent.GameEventDispatcher;
@@ -2816,7 +2814,7 @@ public class ServerLevel extends Level implements WorldGenLevel, ca.spottedleaf.
             // Spigot Start
             if (entity.getBukkitEntity() instanceof org.bukkit.inventory.InventoryHolder && (!(entity instanceof ServerPlayer) || entity.getRemovalReason() != Entity.RemovalReason.KILLED)) { // SPIGOT-6876: closeInventory clears death message
                 // Paper start - Fix merchant inventory not closing on entity removal
-                if (entity.getBukkitEntity() instanceof org.bukkit.inventory.Merchant merchant && merchant.getTrader() != null) {
+                if (!VoidTradingFixConfig.enabled && entity.getBukkitEntity() instanceof org.bukkit.inventory.Merchant merchant && merchant.getTrader() != null) { // Mint
                     merchant.getTrader().closeInventory(org.bukkit.event.inventory.InventoryCloseEvent.Reason.UNLOADED);
                 }
                 // Paper end - Fix merchant inventory not closing on entity removal
diff --git a/src/main/java/net/minecraft/world/entity/item/FallingBlockEntity.java b/src/main/java/net/minecraft/world/entity/item/FallingBlockEntity.java
index 5d6b1a63a2a213f8a4e81c5e574847007a82007b..c3940456f1e0f7914bbd6ed01d8e5a1edf62e916 100644
--- a/src/main/java/net/minecraft/world/entity/item/FallingBlockEntity.java
+++ b/src/main/java/net/minecraft/world/entity/item/FallingBlockEntity.java
@@ -1,5 +1,6 @@
 package net.minecraft.world.entity.item;
 
+import com.menthamc.mint.config.modules.fix.UnsafeTeleportationConfig;
 import com.mojang.logging.LogUtils;
 import java.util.Iterator;
 import java.util.function.Predicate;
@@ -69,7 +70,7 @@ public class FallingBlockEntity extends Entity {
     public float fallDamagePerDistance;
     @Nullable
     public CompoundTag blockData;
-    public boolean forceTickAfterTeleportToDuplicate;
+    public static boolean forceTickAfterTeleportToDuplicate =  UnsafeTeleportationConfig.enabled; // Mint
     protected static final EntityDataAccessor<BlockPos> DATA_START_POS = SynchedEntityData.defineId(FallingBlockEntity.class, EntityDataSerializers.BLOCK_POS);
     public boolean autoExpire = true; // Paper - Expand FallingBlock API
 
@@ -419,7 +420,7 @@ public class FallingBlockEntity extends Entity {
         boolean flag = (resourcekey1 == Level.END || resourcekey == Level.END) && resourcekey1 != resourcekey;
         Entity entity = super.changeDimension(teleportTarget);
 
-        this.forceTickAfterTeleportToDuplicate = entity != null && flag && io.papermc.paper.configuration.GlobalConfiguration.get().unsupportedSettings.allowUnsafeEndPortalTeleportation; // Paper
+        forceTickAfterTeleportToDuplicate = entity != null && flag && (io.papermc.paper.configuration.GlobalConfiguration.get().unsupportedSettings.allowUnsafeEndPortalTeleportation || forceTickAfterTeleportToDuplicate); // Paper // Mint
         return entity;
     }
 }
diff --git a/src/main/java/org/bukkit/craftbukkit/CraftServer.java b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
index dee23b4b96b7f2c6af54a6affe385b183479f8cc..3e50e3971adc816e05a7d6f9a3999cb8077e0c34 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftServer.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
@@ -8,6 +8,7 @@ import com.google.common.collect.ImmutableList;
 import com.google.common.collect.Iterators;
 import com.google.common.collect.Lists;
 import com.google.common.collect.MapMaker;
+import com.menthamc.mint.config.MintConfig;
 import com.mojang.authlib.GameProfile;
 import com.mojang.brigadier.StringReader;
 import com.mojang.brigadier.exceptions.CommandSyntaxException;
@@ -1172,6 +1173,8 @@ public final class CraftServer implements Server {
             if (console.isDebugging()) io.papermc.paper.util.TraceUtil.dumpTraceForThread(worker.getThread(), "still running"); // Paper - Debugging
         }
         io.papermc.paper.plugin.PluginInitializerManager.reload(this.console); // Paper
+        MintConfig.reloadConfig(); // Mint
+        logger.info("Mint config is reloaded."); // Mint
         this.loadPlugins();
         this.enablePlugins(PluginLoadOrder.STARTUP);
         this.enablePlugins(PluginLoadOrder.POSTWORLD);
